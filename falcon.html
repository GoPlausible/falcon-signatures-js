<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Falcon Signatures - Post-Quantum Cryptography Demo</title>
    <link rel="stylesheet" href="falcon.css" />
</head>

<body>
    <!-- Dynamic Floating Background -->
    <div class="background-animation">
        <div class="floating-gradient gradient-1"></div>
        <div class="floating-gradient gradient-2"></div>
        <div class="floating-gradient gradient-3"></div>
        <div class="floating-gradient gradient-4"></div>
        <div class="floating-gradient gradient-5"></div>
        <div class="floating-gradient gradient-6"></div>
        <!-- Additional particle elements -->
        <div class="particle particle-1"></div>
        <div class="particle particle-2"></div>
        <div class="particle particle-3"></div>
        <div class="particle particle-4"></div>
    </div>

    <!-- Header -->
    <header>
        <h1>Falcon Deterministic Signatures</h1>
        <h2>Post-Quantum Cryptography Demo</h2>
        <div class="tagline">
            A JavaScript implementation of the Falcon deterministic post-quantum signature algorithm
        </div>
        <a id="sdk-button" class="action-button" href="https://www.npmjs.com/package/falcon-algo-sdk" target="_blank" rel="noopener noreferrer">Get the SDK</a>
        <button id="generateBtn" class="action-button">Generate Falcon Keys</button>
        <button id="resetBtn" class="action-button" style="display: none;">Reset Demo</button>
        <div class="spinner" id="spinner"></div>
    </header>

    <!-- Main Content -->
    <div class="content-container">

        <!-- Results Container -->
        <div id="resultsContainer" class="result-container">
            <div class="result-icon">üîë</div>
            <h3 class="result-title">Falcon Keys Generated</h3>
            
            <div class="result-details">
                <div class="param-row">
                    <span class="param-label">Public Key:</span>
                    <div class="param-value" id="publicKeyValue"></div>
                    <div class="param-value" style="margin-top: 8px; font-size: 0.9em; color: #a5f3fc;">
                        <span id="publicKeyLength">0</span> bytes (1793 bytes for FALCON-1024)
                    </div>
                    <div class="action-row">
                        <button class="copy-btn" onclick="copyToClipboard('publicKeyValue')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                            Copy
                        </button>
                        <button class="download-btn" onclick="downloadData('publicKeyValue', 'falcon_pk.txt')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
                
                <div class="param-row">
                    <span class="param-label">Secret Key:</span>
                    <div class="param-value" id="secretKeyValue"></div>
                    <div class="param-value" style="margin-top: 8px; font-size: 0.9em; color: #a5f3fc;">
                        <span id="secretKeyLength">0</span> bytes (2305 bytes for FALCON-1024)
                    </div>
                    <div class="action-row">
                        <button class="copy-btn" onclick="copyToClipboard('secretKeyValue')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                            Copy
                        </button>
                        <button class="download-btn" onclick="downloadData('secretKeyValue', 'falcon_sk.txt')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
            </div>

            <div class="action-row">
                <button id="signBtn" class="action-button secondary-button">Sign Message</button>
                <button id="verifyBtn" class="action-button secondary-button">Verify Signature</button>
            </div>
        </div>

        <!-- Signature Results Container -->
        <div id="signatureContainer" class="result-container">
            <div class="result-icon">‚úçÔ∏è</div>
            <h3 class="result-title">Message Signed</h3>
            
            <div class="result-details">
                <div class="param-row">
                    <span class="param-label">Message:</span>
                    <div class="param-value" id="signedMessageValue"></div>
                    <div class="action-row">
                        <button class="copy-btn" onclick="copyToClipboard('signedMessageValue')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                            Copy
                        </button>
                        <button class="download-btn" onclick="downloadData('signedMessageValue', 'falcon_message.txt')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                            Download
                        </button>
                    </div>
                </div>
                
            <div class="param-row">
                <span class="param-label">Signature:</span>
                <div class="param-value" id="signatureValue"></div>
                <div class="action-row">
                    <button class="copy-btn" onclick="copyToClipboard('signatureValue')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                        </svg>
                        Copy
                    </button>
                    <button class="download-btn" onclick="downloadData('signatureValue', 'falcon_sig_compressed.txt')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download
                    </button>
                </div>
            </div>
            
            <div class="param-row">
                <span class="param-label">Format:</span>
                <div class="param-value" id="signatureFormatValue">Compressed</div>
                <div class="param-value" style="margin-top: 8px; font-size: 0.9em; color: #a5f3fc;">
                    <span id="signatureLength">0</span> bytes 
                    <span id="signatureFormatNote">(~1230 bytes variable length for Compressed, 1538 bytes fixed for Constant-Time)</span>
                </div>
            </div>
            
            <div class="param-row">
                <span class="param-label">Salt Version:</span>
                <div class="param-value" id="saltVersionValue">0</div>
            </div>
            </div>

            <div class="action-row">
                <button id="backToKeysBtn" class="action-button secondary-button">Back to Keys</button>
                <button id="convertSignatureBtn" class="action-button secondary-button">Convert to Constant-Time</button>
                <button id="verifySignatureBtn" class="action-button secondary-button">Verify This Signature</button>
            </div>
        </div>

        <!-- Verification Results Container -->
        <div id="verificationContainer" class="result-container">
            <div class="result-icon" id="verificationIcon">‚ùì</div>
            <h3 class="result-title" id="verificationTitle">Signature Verification</h3>
            
            <div class="result-details">
                <div class="param-row">
                    <span class="param-label">Message:</span>
                    <div class="param-value" id="verifyMessageValue"></div>
                </div>
                
            <div class="param-row">
                <span class="param-label">Signature:</span>
                <div class="param-value" id="verifySignatureValue"></div>
            </div>
            
            <div class="param-row">
                <span class="param-label">Format:</span>
                <div class="param-value" id="verifyFormatValue">Compressed</div>
            </div>

                <div class="param-row">
                    <span class="param-label">Public Key:</span>
                    <div class="param-value" id="verifyPublicKeyValue"></div>
                </div>
            </div>

            <div id="verificationResult" class="success-message">
                ‚úÖ Signature verified successfully! The message was signed by the owner of this public key.
            </div>

            <div id="verificationError" class="error-message">
                ‚ùå Signature verification failed! The message may have been tampered with or signed with a different key.
            </div>

            <div class="action-row">
                <button id="backToSignatureBtn" class="action-button secondary-button">Back to Signature</button>
                <button id="startOverBtn" class="action-button secondary-button">Start Over</button>
            </div>
        </div>
    </div>

    <!-- Sign Message Modal -->
    <div id="signModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('signModal')">&times;</button>
            <h3 class="modal-title">Enter Message to Sign</h3>
            <textarea id="messageInput" class="modal-input" placeholder="Type your message here..."></textarea>
            <div class="modal-buttons">
                <button class="action-button secondary-button" onclick="closeModal('signModal')">Cancel</button>
                <button class="action-button secondary-button" onclick="signMessage()">Sign with Compressed Format</button>
            </div>
        </div>
    </div>
    
    <!-- Convert Signature Modal -->
    <div id="convertModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('convertModal')">&times;</button>
            <h3 class="modal-title">Convert Signature Format</h3>
            <div class="param-row">
                <span class="param-label">Current Format:</span>
                <div class="param-value" id="currentFormatValue">Compressed</div>
            </div>
            <div class="param-row">
                <span class="param-label">Convert To:</span>
                <div class="param-value" id="convertToFormatValue">Constant-Time</div>
            </div>
            <div class="modal-buttons">
                <button class="action-button secondary-button" onclick="closeModal('convertModal')">Cancel</button>
                <button class="action-button secondary-button" onclick="convertSignatureFormat()">Convert</button>
            </div>
        </div>
    </div>

    <!-- Verify Signature Modal -->
    <div id="verifyModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('verifyModal')">&times;</button>
            <h3 class="modal-title">Verify a Signature</h3>
            
            <div class="param-row">
                <span class="param-label">Message:</span>
                <textarea id="verifyMessageInput" class="modal-input" placeholder="Enter the original message..."></textarea>
            </div>
            
            <div class="param-row">
                <span class="param-label">Signature:</span>
                <textarea id="verifySignatureInput" class="modal-input" placeholder="Enter the signature (hex format)..."></textarea>
            </div>
            
            <div class="param-row">
                <span class="param-label">Public Key:</span>
                <textarea id="verifyPublicKeyInput" class="modal-input" placeholder="Enter the public key (hex format)..."></textarea>
            </div>
            
            <div class="modal-buttons">
                <button class="action-button secondary-button" onclick="closeModal('verifyModal')">Cancel</button>
                <button class="action-button secondary-button" onclick="verifySignature()">Verify</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <span class="footer-text">Falcon Deterministic Post-Quantum Signatures</span>
        </div>
        <a class="footer-text" href="https://github.com/algorand/falcon" target="_blank" rel="noopener noreferrer">Algorand Falcon GitHub Repository</a>
    </footer>

    <!-- Load Falcon Module -->
    <script type="module">
        import Falcon from './index.js';
        
        // Global variables for use across the application
        window.falconInstance = null;
        window.publicKey = null; 
        window.secretKey = null;
        window.signature = null;
        window.signedMessage = null;
        window.signatureFormat = null;
        
        let falconInstance;
        let publicKey, secretKey, signature, signedMessage, signatureFormat;

        // Initialize the Falcon module
        async function initModule() {
            try {
                falconInstance = new Falcon();
                // Wait for initialization
                await falconInstance._ensureInitialized();
                document.getElementById('generateBtn').disabled = false;
                console.log("Falcon module loaded successfully");
            } catch (error) {
                console.error("Failed to load Falcon module:", error);
                alert("Failed to load the Falcon module. Please check the console for details.");
            }
        }

        // Helper functions for hex conversion
        function hexToBytes(hex) {
            return new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
        }

        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join("");
        }

        // Generate Falcon keypair
        window.generateKeys = async function() {
            if (!falconInstance) {
                alert("Falcon module not loaded yet. Please wait.");
                return;
            }

            const spinner = document.getElementById('spinner');
            const generateBtn = document.getElementById('generateBtn');
            
            generateBtn.disabled = true;
            spinner.style.display = 'block';

            // Use setTimeout to allow the UI to update before the heavy computation
            setTimeout(async () => {
                try {
                    // Generate keypair using our Falcon class
                    const keys = await falconInstance.keypair();
                    
                    // Convert keys to hex for storage and display
                    publicKey = Falcon.bytesToHex(keys.publicKey);
                    secretKey = Falcon.bytesToHex(keys.secretKey);
                    // Also set the global window variables
                    window.publicKey = publicKey;
                    window.secretKey = secretKey;
                    
                    // Display the keys in truncated format
                    const truncateKey = (key) => {
                        if (key.length <= 40) return key;
                        return key.substring(0, 20) + '...' + key.substring(key.length - 20);
                    };
                    
                    // Store full keys but display truncated versions
                    document.getElementById('publicKeyValue').textContent = truncateKey(publicKey);
                    document.getElementById('publicKeyValue').setAttribute('data-full-key', publicKey);
                    document.getElementById('secretKeyValue').textContent = truncateKey(secretKey);
                    document.getElementById('secretKeyValue').setAttribute('data-full-key', secretKey);
                    
                    // Display key lengths
                    const pkBytes = Falcon.hexToBytes(publicKey);
                    const skBytes = Falcon.hexToBytes(secretKey);
                    document.getElementById('publicKeyLength').textContent = pkBytes.length;
                    document.getElementById('secretKeyLength').textContent = skBytes.length;
                    
                    // Show the results container and hide generate button, show reset button
                    document.getElementById('resultsContainer').style.display = 'block';
                    document.getElementById('generateBtn').style.display = 'none';
                    document.getElementById('resetBtn').style.display = 'block';
                } catch (error) {
                    console.error("Error generating keys:", error);
                    alert("Failed to generate keys: " + error.message);
                } finally {
                    spinner.style.display = 'none';
                    generateBtn.disabled = false;
                }
            }, 100);
        };

        // Sign a message
        window.signMessage = function() {
            if (!falconInstance || !secretKey) {
                alert("Falcon module not loaded or no secret key available.");
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert("Please enter a message to sign.");
                return;
            }

            const spinner = document.getElementById('spinner');
            spinner.style.display = 'block';
            
            // Close the modal
            closeModal('signModal');

            // Use setTimeout to allow the UI to update before the heavy computation
            setTimeout(async () => {
                try {
                    // Sign the message using our Falcon class (compressed format)
                    const sig = await falconInstance.sign(message, secretKey);
                    
                    // Convert signature to hex for display
                    signature = Falcon.bytesToHex(sig);
                    signedMessage = message;
                    signatureFormat = "compressed";
                    
                    // Also set the global window variables
                    window.signature = signature;
                    window.signedMessage = signedMessage;
                    window.signatureFormat = "compressed";
                    
                    // Get salt version
                    const saltVersion = await falconInstance.getSaltVersion(sig);
                    
                    // Display the signature and message (truncate signature)
                    const truncateSignature = (sig) => {
                        if (sig.length <= 40) return sig;
                        return sig.substring(0, 20) + '...' + sig.substring(sig.length - 20);
                    };
                    
                    document.getElementById('signedMessageValue').textContent = signedMessage;
                    document.getElementById('signatureValue').textContent = truncateSignature(signature);
                    document.getElementById('signatureValue').setAttribute('data-full-signature', signature);
                    document.getElementById('signatureFormatValue').textContent = "Compressed";
                    document.getElementById('saltVersionValue').textContent = saltVersion;
                    
                    // Display signature length
                    const sigBytes = Falcon.hexToBytes(signature);
                    document.getElementById('signatureLength').textContent = sigBytes.length;
                    
                    // Show the signature container
                    document.getElementById('resultsContainer').style.display = 'none';
                    document.getElementById('signatureContainer').style.display = 'block';
                } catch (error) {
                    console.error("Error signing message:", error);
                    alert("Failed to sign message: " + error.message);
                } finally {
                    spinner.style.display = 'none';
                }
            }, 100);
        };
        
        // Convert signature format
        window.convertSignatureFormat = function() {
            if (!falconInstance || !signature) {
                alert("Falcon module not loaded or no signature available.");
                return;
            }

            const spinner = document.getElementById('spinner');
            spinner.style.display = 'block';
            
            // Close the modal if open
            closeModal('convertModal');

            // Use setTimeout to allow the UI to update before the heavy computation
            setTimeout(async () => {
                try {
                    console.log("Converting signature format:", signatureFormat);
                    console.log("Current signature:", signature.substring(0, 20) + "...");
                    
                    // Convert the signature based on current format
                    if (signatureFormat === "compressed") {
                        // Convert compressed signature to Uint8Array
                        const compressedBytes = Falcon.hexToBytes(signature);
                        console.log("Compressed signature length:", compressedBytes.length);
                        
                        // Convert to constant-time format
                        const ctSig = await falconInstance.convertToConstantTime(compressedBytes);
                        console.log("CT signature length:", ctSig.length);
                        
                        // Convert back to hex
                        signature = Falcon.bytesToHex(ctSig);
                        signatureFormat = "constant-time";
                        
                        // Also update the global window variables
                        window.signature = signature;
                        window.signatureFormat = "constant-time";
                        
                        // Display the signature (truncate for display)
                        const truncateSignature = (sig) => {
                            if (sig.length <= 40) return sig;
                            return sig.substring(0, 20) + '...' + sig.substring(sig.length - 20);
                        };
                        
                        document.getElementById('signatureValue').textContent = truncateSignature(signature);
                        document.getElementById('signatureValue').setAttribute('data-full-signature', signature);
                        document.getElementById('signatureFormatValue').textContent = "Constant-Time";
                        
                        // Update signature length
                        const sigBytes = Falcon.hexToBytes(signature);
                        document.getElementById('signatureLength').textContent = sigBytes.length;
                        
                        // Hide the convert button
                        document.getElementById('convertSignatureBtn').style.display = 'none';
                        
                        console.log("Conversion completed successfully");
                    } else {
                        console.log("Not converting: signature format is already", signatureFormat);
                    }
                } catch (error) {
                    console.error("Error converting signature:", error);
                    alert("Failed to convert signature: " + error.message);
                } finally {
                    spinner.style.display = 'none';
                }
            }, 100);
        };

        // Verify a signature
        window.verifySignature = function() {
            if (!falconInstance) {
                alert("Falcon module not loaded yet. Please wait.");
                return;
            }

            let msg, sig, pk;
            
            // Check if we're verifying from the modal or from the signature container
            if (document.getElementById('verifyModal').style.display === 'flex') {
                // Get values from the modal inputs
                msg = document.getElementById('verifyMessageInput').value.trim();
                sig = document.getElementById('verifySignatureInput').value.trim();
                pk = document.getElementById('verifyPublicKeyInput').value.trim();
                
                // Close the modal
                closeModal('verifyModal');
            } else {
                // Use the values from the current signature
                msg = signedMessage;
                sig = signature;
                pk = publicKey;
            }
            
            if (!msg || !sig || !pk) {
                alert("Please provide a message, signature, and public key.");
                return;
            }

            const spinner = document.getElementById('spinner');
            spinner.style.display = 'block';

            // Use setTimeout to allow the UI to update before the heavy computation
            setTimeout(async () => {
                try {
                    // Detect signature type based on format or header byte
                    const sigBytes = Falcon.hexToBytes(sig);
                    const headerByte = sigBytes[0];
                    const isCompressed = (headerByte === 0xBA); // FALCON_DET1024_SIG_COMPRESSED_HEADER
                    const isCT = (headerByte === 0xDA); // FALCON_DET1024_SIG_CT_HEADER
                    
                    let result;
                    let format;
                    
                    if (isCompressed) {
                        format = "Compressed";
                        result = await falconInstance.verify(msg, sig, pk);
                    } else if (isCT) {
                        format = "Constant-Time";
                        result = await falconInstance.verifyConstantTime(msg, sig, pk);
                    } else {
                        format = "Unknown";
                        throw new Error(`Unknown signature format (header byte: 0x${headerByte.toString(16)})`);
                    }
                    
                    // Display the verification result with truncated values
                    const truncateValue = (value) => {
                        if (value.length <= 40) return value;
                        return value.substring(0, 20) + '...' + value.substring(value.length - 20);
                    };
                    
                    document.getElementById('verifyMessageValue').textContent = msg;
                    document.getElementById('verifySignatureValue').textContent = truncateValue(sig);
                    document.getElementById('verifySignatureValue').setAttribute('data-full-value', sig);
                    document.getElementById('verifyPublicKeyValue').textContent = truncateValue(pk);
                    document.getElementById('verifyPublicKeyValue').setAttribute('data-full-value', pk);
                    document.getElementById('verifyFormatValue').textContent = format;
                    
                    if (result) {
                        // Verification successful
                        document.getElementById('verificationIcon').textContent = '‚úÖ';
                        document.getElementById('verificationTitle').textContent = 'Signature Verified';
                        document.getElementById('verificationResult').style.display = 'block';
                        document.getElementById('verificationError').style.display = 'none';
                    } else {
                        // Verification failed
                        document.getElementById('verificationIcon').textContent = '‚ùå';
                        document.getElementById('verificationTitle').textContent = 'Verification Failed';
                        document.getElementById('verificationResult').style.display = 'none';
                        document.getElementById('verificationError').style.display = 'block';
                    }
                    
                    // Show the verification container
                    document.getElementById('resultsContainer').style.display = 'none';
                    document.getElementById('signatureContainer').style.display = 'none';
                    document.getElementById('verificationContainer').style.display = 'block';
                } catch (error) {
                    console.error("Error verifying signature:", error);
                    alert("Failed to verify signature: " + error.message);
                } finally {
                    spinner.style.display = 'none';
                }
            }, 100);
        };

        // Initialize the module when the page loads
        initModule().then(() => {
            // Automatically generate keys when the module is loaded
            generateKeys();
        });

        // Make functions available globally
        window.initModule = initModule;
    </script>

    <!-- Utility Functions -->
    <script>
        // Copy to clipboard
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            // Use the full value if available, otherwise use the displayed text
            const text = element.getAttribute('data-full-key') || 
                         element.getAttribute('data-full-signature') || 
                         element.getAttribute('data-full-value') || 
                         element.textContent;
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    // Show a temporary success message
                    const originalText = element.innerHTML;
                    element.innerHTML = '<span style="color: #10b981;">‚úì Copied to clipboard!</span>';
                    setTimeout(() => {
                        element.innerHTML = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy to clipboard: ' + err);
                });
        }

        // Download data as a file
        function downloadData(elementId, filename) {
            const element = document.getElementById(elementId);
            // Use the full value if available, otherwise use the displayed text
            const text = element.getAttribute('data-full-key') || 
                         element.getAttribute('data-full-signature') || 
                         element.getAttribute('data-full-value') || 
                         element.textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // Open modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Generate keys button
            document.getElementById('generateBtn').addEventListener('click', generateKeys);
            
            // Sign message button
            document.getElementById('signBtn').addEventListener('click', function() {
                openModal('signModal');
            });
            
            // Verify signature button
            document.getElementById('verifyBtn').addEventListener('click', function() {
                openModal('verifyModal');
            });
            
            // Convert signature button
            document.getElementById('convertSignatureBtn').addEventListener('click', function() {
                // Check the global window.signatureFormat to ensure it's accessible everywhere
                if (window.signatureFormat === "constant-time") {
                    alert("This signature is already in constant-time format.");
                    return;
                }
                
                // For simplicity, just convert directly
                convertSignatureFormat();
            });
            
            // Back to keys button
            document.getElementById('backToKeysBtn').addEventListener('click', function() {
                document.getElementById('signatureContainer').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
            });
            
            // Verify this signature button
            document.getElementById('verifySignatureBtn').addEventListener('click', function() {
                verifySignature();
            });
            
            // Back to signature button
            document.getElementById('backToSignatureBtn').addEventListener('click', function() {
                document.getElementById('verificationContainer').style.display = 'none';
                document.getElementById('signatureContainer').style.display = 'block';
            });
            
            // Start over button
            document.getElementById('startOverBtn').addEventListener('click', function() {
                document.getElementById('verificationContainer').style.display = 'none';
                document.getElementById('resultsContainer').style.display = 'block';
            });
            
            // Reset button
            document.getElementById('resetBtn').addEventListener('click', function() {
                // Hide all result containers
                document.getElementById('resultsContainer').style.display = 'none';
                document.getElementById('signatureContainer').style.display = 'none';
                document.getElementById('verificationContainer').style.display = 'none';
                
                // Show generate button, hide reset button
                document.getElementById('generateBtn').style.display = 'block';
                document.getElementById('resetBtn').style.display = 'none';
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target.id);
                }
            });
        });
    </script>
</body>

</html>
